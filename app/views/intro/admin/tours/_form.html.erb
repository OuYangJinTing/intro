<%= form_for @tour, url: url, html: { class: "intro-admin__form intro-admin__tour-form #{yield(:tour_form_class)}" } do |f| %>
  <% if @tour.errors.any? %>
    <div class='field error'>
      <div class='message list'>
        <% @tour.errors.full_messages.each do |message| %>
          <%= content_tag :div, message, class: 'item' %>
        <% end %>
      </div>
    </div>
  <% elsif flash.notice %>
    <div class='field info'>
      <%= content_tag :div, flash.notice, class: 'message' %>
    </div>
  <% end %>

  <div class='fields simple-route-fields'>
    <div class='twelve wide field'>
      <%= f.label :ident do %>
        <%= t('intro.admin.tour.simple_route') %>
        <i class='intro-admin__question' title="<%= t('intro.admin.tips.simple_route') %>"></i>
      <% end %>
      <%= text_field_tag 'tour[route][simple]', @tour.simple_route, placeholder: t('intro.admin.placeholders.simple_route'), class: 'js-tour-simple-route-input' %>
    </div>

    <div class='four wide field'>
      <div class='checkbox intro-admin__checkbox'>
        <%= check_box_tag 'tour[route][strict]', 1, @tour.strict_route? %>
        <%= label_tag 'tour[route][strict]', t('intro.admin.placeholders.strict_route'), title: t('intro.admin.tips.strict_route') %>
      </div>
    </div>
  </div>

  <div class='four fields'>
    <div class='field required'>
      <%= f.label :ident, t('intro.admin.tour.ident') %>
      <%= f.text_field :ident, placeholder: t('intro.admin.placeholders.tour_ident'), required: true, class: 'js-tour-ident-input' %>
    </div>

    <div class='field'>
      <%= f.label :controller_path, 'Controller' %>
      <%= f.text_field :controller_path, placeholder: 'Controller path', class: 'js-tour-controller-input' %>
    </div>

    <div class='field'>
      <%= f.label :action_name, 'Action' %>
      <%= f.text_field :action_name, placeholder: 'Action name', class: 'js-tour-action-input' %>
    </div>

    <div class='field'>
      <%= f.label :action_name, t('intro.admin.tour.query_params') %>
      <%= text_field_tag 'tour[route][query]', @tour.route[:query], placeholder: t('intro.admin.placeholders.query_params'), class: 'js-tour-query-input' %>
    </div>
  </div>

  <%= render 'steps' %>

  <details class='field'>
    <summary><%= t('intro.admin.others') %></summary>
    <div class='intro-admin__tour-others'>
      <div class='field'>
        <div class='checkbox intro-admin__checkbox'>
          <%= check_box_tag 'tour[options][overlay_visible]', 1, @tour.options['overlay_visible'] %>
          <%= label_tag 'tour[options][overlay_visible]', t('intro.admin.placeholders.overlay_visible') %>
        </div>
      </div>

      <% btn_visible = @tour.new_record? || @tour.options['btn_visible'] %>

      <div class='field' style="<%= 'margin-bottom: 1em;' unless btn_visible %>">
        <div class='checkbox intro-admin__checkbox'>
          <%= check_box_tag 'tour[options][btn_visible]', 1, btn_visible, class: 'js-intro-btn-visible-input' %>
          <%= label_tag 'tour[options][btn_visible]', t('intro.admin.placeholders.btn_visible') %>
        </div>
      </div>

      <div class='two fields js-intro-complete-btn-fields <%= 'intro-admin__hide' unless btn_visible %>'>
        <div class='field'>
          <%= label_tag :btn_complete_text, t('intro.admin.tour.btn_complete_text') %>
          <%= text_field_tag 'tour[options][btn_complete_text]', @tour.options['btn_complete_text'], placeholder: t('intro.admin.placeholders.btn_complete_text') %>
        </div>

        <div class='field'>
          <%= label_tag :btn_complete_link, t('intro.admin.tour.btn_complete_link') %>
          <%= text_field_tag 'tour[options][btn_complete_link]', @tour.options['btn_complete_link'], placeholder: t('intro.admin.placeholders.btn_complete_link') %>
        </div>
      </div>

      <div class='three fields'>
        <div class='field'>
          <%= f.label :expired_at, t('intro.admin.tour.expired_time') %>
          <%= f.text_field :expired_at, type: :date %>
        </div>
      </div>
    </div>
  </details>

  <div class='field intro-admin__tour-actions'>
    <%= button_tag t('intro.admin.submit'), class: 'intro-admin__button prime', type: :submit %>
    <%= button_tag t('intro.admin.test'), class: 'intro-admin__button js-intro-admin__button-test', type: :button %>
    <%= yield(:form_actions) %>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var simpleRouteInput = document.querySelector('.js-tour-simple-route-input')
    var identInput = document.querySelector('.js-tour-ident-input')
    var controllerInput = document.querySelector('.js-tour-controller-input')
    var actionInput = document.querySelector('.js-tour-action-input')
    var queryInput = document.querySelector('.js-tour-query-input')
    var testBtn = document.querySelector('.js-intro-admin__button-test')
    var form = document.querySelector('.intro-admin__tour-form')
    var introTour

    // auto fill ident, controller, action, query input
    simpleRouteInput.addEventListener('change', function (e) {
      if (!e.target.value) return

      var xhr = new XMLHttpRequest()
      xhr.open('GET', "<%= route_admin_tours_path %>?path=" + encodeURIComponent(e.target.value))
      xhr.setRequestHeader('Content-Type', 'application/json')
      xhr.onload = function () {
        if (xhr.status !== 200) return

        var res = JSON.parse(xhr.response)
        var data = res.data

        if (!data) return
        if (data.source) {
          controllerInput.value = data.source.controller
          actionInput.value = data.source.action

          if (/^(([\/\w]+)#(\w+)-.*)|(\s*)$/.test(identInput.value)) {
            identInput.value = data.source.controller + '#' + data.source.action + '-' + Math.random().toString(36).slice(-6)
          }
        }
        if (data.query) {
          queryInput.value = data.query
        }
      }
      xhr.send()
    })

    // test tour
    testBtn.addEventListener('click', function () {
      if (testBtn.classList.contains('intro-loading')) return

      testBtn.classList.add('intro-loading')
      introTour && introTour.hide()

      var data = new FormData(form)
      data.append('_method', 'POST')

      var xhr = new XMLHttpRequest()
      xhr.open('POST', "<%= attempt_admin_tours_path %>")

      xhr.onload = function () {
        testBtn.classList.remove('intro-loading')

        if (xhr.status !== 200) return

        var res = JSON.parse(xhr.response)

        if (res.data) {
          introTour = new window._intro.Tour(res.data)

          introTour.test({
            element: '.js-intro-admin__button-test'
          })
        }
      }

      xhr.onerror = function () {
        testBtn.classList.remove('intro-loading')
      }

      xhr.send(data)
    })

    // complete btn actions
    document.querySelector('.js-intro-btn-visible-input').addEventListener('change', function (e) {
      var completeBtnFields = document.querySelector('.js-intro-complete-btn-fields')

      if (e.target.checked) {
        completeBtnFields.classList.remove('intro-admin__hide')
        e.target.closest('.field').style.marginBottom = null
      } else {
        completeBtnFields.classList.add('intro-admin__hide')
        e.target.closest('.field').style.marginBottom = '1em'
      }
    })
  })
</script>